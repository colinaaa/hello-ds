name: C/C++ CI

on: [push]

jobs:
  build:
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
        env:
          - { CI: gh, CC: gcc-9, CXX: g++-9 }
          - { CI: gh, CC: clang-9, CXX: clang++-9 }
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v2
    - name: install-libc++
      env: ${{ matrix.env }}
      run: |
        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key 2>/dev/null | sudo apt-key add -
        sudo add-apt-repository 'deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-9 main' -y
        sudo apt-get update -q
        sudo apt-get install -y libc++-9-dev libc++abi-9-dev
      if: runner.os == 'Linux' && env.CC == 'clang-9'
    - name: dep
      env: ${{ matrix.env }}
      run: make dep
    - name: main
      env: ${{ matrix.env }}
      run: make main
    - name: all
      env: ${{ matrix.env }}
      run: make ci
    - name: cov
      run: make cov.info && lcov --list cov.info
    - uses: codecov/codecov-action@v1
      with:
        file: ./cov.info # optional
    - uses: coverallsapp/github-action@master
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        path-to-lcov: ./cov.info
        parallel: true
    - uses: coverallsapp/github-action@master
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        parallel-finished: true
